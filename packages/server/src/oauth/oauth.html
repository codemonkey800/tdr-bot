<!doctype html>
<html>
  <head>
    <title>My Discord OAuth2 App</title>
  </head>

  <body>
    <div id="info">Hoi!</div>

    <a id="login" style="display: none" href="http://localhost:8081/oauth"
      >Identify Yourself</a
    >

    <script>
      function generateRandomString() {
        let randomString = ''
        const randomNumber = Math.floor(Math.random() * 10)

        for (let i = 0; i < 20 + randomNumber; i++) {
          randomString += String.fromCharCode(
            33 + Math.floor(Math.random() * 94),
          )
        }

        return randomString
      }

      window.onload = async () => {
        const fragment = new URLSearchParams(window.location.hash.slice(1))
        const [accessToken, tokenType, state] = [
          fragment.get('access_token'),
          fragment.get('token_type'),
          fragment.get('state'),
        ]

        if (!accessToken) {
          const randomString = generateRandomString()
          localStorage.setItem('oauth-state', randomString)

          document.getElementById('login').href += `&state=${btoa(
            randomString,
          )}`
          document.getElementById('login').style.display = 'block'

          return
        }

        if (
          localStorage.getItem('oauth-state') !==
          atob(decodeURIComponent(state))
        ) {
          console.log('You may have been clickjacked!')
          return
        }

        try {
          const res = await fetch('https://discord.com/api/users/@me', {
            headers: {
              authorization: `${tokenType} ${accessToken}`,
            },
          })
          const data = await res.json()

          const { username, discriminator } = response

          document.getElementById('info').innerText +=
            ` ${username}#${discriminator}`
        } catch (err) {
          console.error(err)
        }
      }
    </script>
  </body>
</html>
